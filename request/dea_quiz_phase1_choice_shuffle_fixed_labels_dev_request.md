# 開発依頼書：DEAクイズアプリ Phase 1-②（改訂版）「表示ラベル固定（A/B/C/D）＋テキスト入れ替え」機能（Codex向け）

作成日：2026-02-14  
対象リポジトリ：`quiz-practice` / `dea-quiz-app`  
対象URL： https://github.com/yuyuyu0706/quiz-practice/tree/main/dea-quiz-app  
依頼者：草野  
実装担当：Codex

---

## 1. 目的
DEAクイズWebアプリにおいて、**選択肢の表示ラベル（A/B/C/D）は固定**のまま、  
**選択肢テキスト（本文）だけをランダムに割り当て**ることで、位置暗記を防ぎ、理解ベースの学習を促進する。

> NG：キー（アルファベット）そのものが入れ替わる（AのボタンがC扱いになる等）  
> OK：A/B/C/Dのラベルは常に固定で、Aに表示する「本文」が毎回変わる

---

## 2. スコープ（今回やること）
### 2.1 実装対象
- クイズ画面で表示する **選択肢本文のみをシャッフル**（A/B/C/Dラベルは固定）
- 正解判定がズレないように、**「表示ラベル → 元の選択肢キー」マッピング**を用いて採点する
- 中断/再開（Phase 1-①）と整合：
  - 中断→再開後も、同じ問題について**同じ割り当て（マッピング）**が再現される（必須）

### 2.2 今回やらないこと
- 出題順のランダム化（別機能）
- 結果エクスポ/インポ
- SRS等の学習アルゴリズム

---

## 3. 要件定義

## 3.1 ユーザーストーリー
- 学習者として、A/B/C/Dのラベルはいつも同じで見慣れたUIのまま、本文だけが入れ替わってほしい。
- 学習者として、中断→再開で割り当てが変わって混乱したくない（再開時は同じ割り当てが良い）。

---

## 3.2 振る舞い（仕様）
### 表示仕様（固定ラベル）
- 画面には常に以下の形式で表示する：
  - `A: <本文>`
  - `B: <本文>`
  - `C: <本文>`
  - `D: <本文>`
- ただし `<本文>` は、元の `choices`（A/B/C/D）から**ランダムに割り当て**る

### 採点仕様（マッピングで正解判定）
- 各問題で「表示ラベル（A/B/C/D）が、元のどの選択肢キーに紐づくか」を保持する
- ユーザーが押したのは **表示ラベル**（例：A）として保存する
- 正解判定は次で行う：
  - `choiceMap[questionId][selectedLabel] === question.answer` なら正解

---

## 4. 実装方針（必須：マッピング保存で再現性確保）
### 4.1 方式：問題ごとに choiceMap を保存（必須）
- セッション（localStorage）に、問題IDごとに「表示ラベル → 元キー」の対応を保存する

#### choiceMap の例
Q1 で「Aに元C、Bに元A、Cに元D、Dに元B」を割り当てた場合：
```json
"choiceMap": {
  "Q1": { "A": "C", "B": "A", "C": "D", "D": "B" }
}
```

#### 表示ロジック（例）
- 表示ラベルが `L` の本文は `question.choices[ choiceMap[Q1][L] ]`

#### 採点ロジック（例）
- ユーザーの選択：`selectedLabel = "A"`
- 正解判定：`choiceMap[Q1]["A"] === question.answer`

### 4.2 再現性（重要）
- 同一セッション内：同じ問題を表示し直しても割り当てが変わらない
- 中断→再開：choiceMap を復元し、割り当てが変わらない（必須）

---

## 5. データ構造（localStorage セッション）変更
Phase 1-① のセッションに以下を追加する。

### 5.1 セッション項目（追加）
- `choiceMap`（必須）
  - `questionId -> {A: <origKey>, B: <origKey>, C: <origKey>, D: <origKey>}`

### 5.2 answers の保存形式（推奨）
- **表示ラベルで保存**（selectedLabel）
  - 例：`answers.Q1.selectedLabel = "A"`
- 既存が「元キー保存（selectedKey）」の場合はどちらでも良いが、必ず以下を満たすこと：
  - 再開時に選択済み状態を正しく再現できる
  - 正誤判定がズレない

#### 推奨セッション例
```json
{
  "questionOrder": ["Q1","Q2"],
  "currentIndex": 0,
  "choiceMap": {
    "Q1": { "A": "C", "B": "A", "C": "D", "D": "B" }
  },
  "answers": {
    "Q1": { "selectedLabel": "A", "isCorrect": true, "answeredAt": "..." }
  }
}
```

---

## 6. UI仕様
- UIの見た目は現状維持でOK（A/B/C/Dのラベル固定が最優先）
- クリック/選択イベントの値は **表示ラベル（A/B/C/D）** として扱う
- 回答済みの場合：
  - 選択済みラベルが再表示時も選択済みになっていること
  - 正解/不正解表示が従来通り動作すること

---

## 7. 受け入れ条件（Acceptance Criteria）
- [ ] 表示ラベル（A/B/C/D）は常に固定で、ランダムにならない
- [ ] 各問題で本文（テキスト）がランダムに割り当てられる
- [ ] 正解判定が常に正しい（割り当てでズレない）
- [ ] 同じセッション内で同じ問題の割り当てが変わらない
- [ ] 中断→再開後も割り当てが再現され、選択済み状態も正しく復元される
- [ ] 既存機能（採点/結果/中断再開）を壊さない

---

## 8. 実装メモ（Codex向け）
- マッピング生成は Fisher–Yates 推奨  
  - 元キー配列 `["A","B","C","D"]` をシャッフルし、表示ラベル `A,B,C,D` に順に割り当てる
- 関数案：
  - `getOrCreateChoiceMap(questionId)`：なければ生成して保存、あれば返す
  - `renderChoices(question, choiceMap)`：A/B/C/D固定で本文を描画
  - `gradeAnswer(question, choiceMap, selectedLabel)`：正誤判定
- 保存の単位：
  - 回答確定時に `saveSession()`（Phase 1-①）を必ず呼ぶ

---

## 9. 成果物
- コード変更（既存ファイルへの追記）
  - `app.js`（choiceMap生成/描画/採点/保存/復元）
  - （必要なら）`index.html`（データ属性やラベル固定のため）
  - （必要なら）`styles.css`
- README更新（任意）
  - 「A/B/C/D固定、本文のみランダム」「中断再開でも割り当て維持」を記載

---

## 10. テスト観点（手動）
1) 同じ問題を前へ/次へで行き来しても、A/B/C/Dの本文割り当てが変わらない  
2) A/B/C/Dのラベル自体は固定で変化しない  
3) 回答して正誤が正しい  
4) 中断→再開しても、本文割り当てが同じで、選択済みも復元される  
5) セッション削除後は新規割り当てが生成される

